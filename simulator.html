<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train of Thought - Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('Train Of Thought Simulator.svg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
        }
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 3rem;
            background: transparent;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            text-decoration: none;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: #333;
            border-radius: 4px;
            position: relative;
        }
        .logo-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 12px solid white;
        }
        .logo-icon::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            height: 4px;
            background: white;
            border-radius: 2px;
        }
        .nav-links {
            display: flex;
            gap: 2.5rem;
        }
        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            font-size: 1rem;
            transition: color 0.3s;
        }
        .nav-links a:hover {
            color: #555;
        }
        .nav-links a.active {
            color: #333;
        }
        .page {
            padding: 3rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .simulator-container {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        .simulator-container h2 {
            color: #667eea;
            margin-bottom: 2rem;
            font-size: 2.5rem;
        }
        .simulator-box {
            background: #1a1a1a;
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 0;
            margin: 2rem 0;
            position: relative;
            overflow: hidden;
            min-height: 500px;
            perspective: 1000px;
        }
        
        /* First-person train cabin view */
        .train-cabin {
            position: relative;
            width: 100%;
            height: 500px;
            background: linear-gradient(to bottom, #2c2c2c 0%, #1a1a1a 50%, #0d0d0d 100%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            overflow: hidden;
        }
        
        /* Windshield frame */
        .windshield-frame {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 15px solid #1a1a1a;
            border-radius: 0 0 20px 20px;
            pointer-events: none;
            z-index: 100;
        }
        
        .windshield-glass {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            background: linear-gradient(to bottom, rgba(135, 206, 235, 0.1) 0%, rgba(135, 206, 235, 0.05) 100%);
            border-radius: 0 0 15px 15px;
            backdrop-filter: blur(1px);
            pointer-events: none;
            z-index: 50;
        }
        
        /* Track view - two pathways converging in perspective */
        .track-view {
            position: absolute;
            bottom: 100px;
            left: 0;
            right: 0;
            height: 400px;
            perspective: 800px;
            transform-style: preserve-3d;
        }
        
        .track-path {
            position: absolute;
            bottom: 0;
            width: 45%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            perspective: 800px;
        }
        
        .track-path.left {
            left: 2%;
            transform-origin: left center;
        }
        
        .track-path.right {
            right: 2%;
            transform-origin: right center;
        }
        
        .track-path.active {
            transform: translateZ(50px) scale(1.1);
        }
        
        /* Track rails with perspective */
        .track-rails {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 200px;
            background: linear-gradient(to top, #2c2c2c 0%, #1a1a1a 50%, #0d0d0d 100%);
            clip-path: polygon(0% 100%, 20% 0%, 80% 0%, 100% 100%);
            transform: rotateX(60deg);
            transform-origin: bottom center;
        }
        
        .rail-lines {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                #fff 0px,
                #fff 15px,
                transparent 15px,
                transparent 30px
            );
            opacity: 0.5;
        }
        
        .rail-lines::before,
        .rail-lines::after {
            content: '';
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: #666;
        }
        
        .rail-lines::before {
            left: -30px;
        }
        
        .rail-lines::after {
            right: -30px;
        }
        .direction-buttons {
            display: flex;
            gap: 2rem;
            justify-content: center;
            margin-top: 2rem;
        }
        .direction-btn {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        .left-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }
        .right-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }
        .direction-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .direction-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        .direction-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .track-lines {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: repeating-linear-gradient(
                to right,
                #fff 0px,
                #fff 12px,
                transparent 12px,
                transparent 24px
            );
            opacity: 0.3;
        }
        /* Rubber chickens on tracks - approaching from distance */
        .rubber-chicken {
            position: absolute;
            width: 50px;
            height: 60px;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(0) translateZ(0) scale(1);
            transform-style: preserve-3d;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 20;
            animation: approach 2s ease-out forwards;
        }
        
        @keyframes approach {
            from {
                transform: translateX(-50%) translateY(0) translateZ(-300px) scale(0.2);
                opacity: 0.3;
            }
            to {
                transform: translateX(-50%) translateY(0) translateZ(0) scale(1);
                opacity: 1;
            }
        }
        
        /* Chicken body */
        .rubber-chicken::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 35px;
            background: linear-gradient(135deg, #ffeb3b 0%, #ffd700 50%, #ffc107 100%);
            border-radius: 50% 50% 45% 45% / 60% 60% 40% 40%;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.3),
                inset 0 -2px 4px rgba(255,193,7,0.5),
                inset 0 2px 4px rgba(255,235,59,0.8);
        }
        
        /* Chicken head */
        .rubber-chicken::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 30px;
            background: linear-gradient(135deg, #ffeb3b 0%, #ffd700 100%);
            border-radius: 50% 50% 45% 45% / 55% 55% 45% 45%;
            box-shadow: 
                0 2px 6px rgba(0,0,0,0.3),
                inset 0 -1px 3px rgba(255,193,7,0.4);
        }
        
        /* Chicken beak */
        .chicken-beak {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 8px;
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 10;
        }
        
        /* Chicken eye */
        .chicken-eye {
            position: absolute;
            top: 8px;
            width: 6px;
            height: 6px;
            background: #000;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(255,255,255,0.5);
        }
        
        .chicken-eye.left {
            left: 35%;
        }
        
        .chicken-eye.right {
            right: 35%;
        }
        
        /* Chicken comb */
        .chicken-comb {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 12px;
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            clip-path: polygon(0% 100%, 20% 0%, 50% 30%, 80% 0%, 100% 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .rubber-chicken.hit {
            opacity: 0;
            transform: translateX(-50%) translateY(0) translateZ(0) scale(0) rotate(720deg);
            pointer-events: none;
        }
        
        /* Control panel at bottom */
        .control-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #1a1a1a 0%, #2c2c2c 100%);
            padding: 20px;
            border-top: 3px solid #667eea;
            z-index: 200;
        }
        .question-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        .question-text {
            font-size: 1.25rem;
            color: #333;
            margin-bottom: 1.5rem;
            line-height: 1.7;
            font-weight: 500;
        }
        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.2rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }
        .round-info {
            background: #ffffff;
            padding: 1.2rem;
            border-radius: 12px;
            margin: 1rem 0;
            border: 2px solid #e9ecef;
        }
        .next-round-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }
        .next-round-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .next-round-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="logo">
            <div class="logo-icon"></div>
            <span>Train Of Thought</span>
        </a>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="simulator.html" class="active">Simulator</a>
            <a href="dashboard.html">Analytics</a>
        </div>
    </nav>
    <div class="page">
        <div class="simulator-container">
            <h2>Trolley Problem Simulator</h2>
            <p style="color: #666; font-size: 1.1rem; margin-bottom: 1.5rem;">Make your choice: divert the train or let it continue. Watch as the train runs over the chickens on your chosen track.</p>
            
            <div class="question-container">
                <div class="question-text" id="questionText">
                    A runaway train is heading towards 5 rubber chickens on the main track. You can divert it to a side track, but there are 2 rubber chickens on that track. What do you do?
                </div>
                <div class="round-info">
                    <div class="score-display">
                        Round: <span id="currentRound">1</span> | Score: <span id="currentScore">0</span> | Chickens Hit: <span id="chickensHit">0</span>
                    </div>
                </div>
            </div>
            
            <div class="simulator-box">
                <div class="train-cabin">
                    <!-- Windshield frame -->
                    <div class="windshield-frame"></div>
                    <div class="windshield-glass"></div>
                    
                    <!-- Track view with perspective -->
                    <div class="track-view" id="trackView">
                        <!-- Left track path -->
                        <div class="track-path left" id="leftTrack">
                            <div class="track-rails">
                                <div class="rail-lines"></div>
                            </div>
                            <!-- Chickens will be added here -->
                        </div>
                        
                        <!-- Right track path -->
                        <div class="track-path right" id="rightTrack">
                            <div class="track-rails">
                                <div class="rail-lines"></div>
                            </div>
                            <!-- Chickens will be added here -->
                        </div>
                    </div>
                    
                    <!-- Control panel -->
                    <div class="control-panel">
                        <div class="direction-buttons">
                            <button class="direction-btn left-btn" id="leftBtn" onclick="makeChoice('left')">
                                ‚Üê Divert Left
                            </button>
                            <button class="direction-btn right-btn" id="rightBtn" onclick="makeChoice('right')">
                                Continue Right ‚Üí
                            </button>
                        </div>
                        <button class="next-round-btn" id="nextRoundBtn" onclick="nextScenario()" style="display: none;">
                            Continue
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Game state with adaptive learning
        let gameState = {
            currentScenario: null,
            moralScore: 0,
            choices: [],
            scenarioHistory: [],
            adaptiveWeights: {
                utilitarian: 0,      // Prefers minimizing total harm
                deontological: 0,     // Prefers following rules
                virtue: 0,            // Prefers character-based decisions
                consequentialist: 0   // Prefers outcome-based decisions
            }
        };

        // Adaptive branching scenarios
        const scenarios = {
            start: {
                id: 'start',
                description: "You're in the driver's seat of a runaway train. Ahead, you see 5 rubber chickens on the main track (right). You can pull a lever to divert to a side track with 1 rubber chicken (left).",
                leftTrack: { chickens: 1 },
                rightTrack: { chickens: 5 },
                options: [
                    { 
                        text: "Pull the lever (divert left)", 
                        choice: 'left',
                        next: 'lever_pulled',
                        moralPoints: { utilitarian: 1, consequentialist: 1 },
                        description: "You pulled the lever! The train diverts to the left track."
                    },
                    { 
                        text: "Do nothing (continue right)", 
                        choice: 'right',
                        next: 'do_nothing',
                        moralPoints: { deontological: 1 },
                        description: "You chose not to act. The train continues on the main track."
                    }
                ]
            },
            lever_pulled: {
                id: 'lever_pulled',
                description: "The train has diverted! You see a giant rubber chicken mascot on the left track ahead. There's also a switch that could stop the train entirely.",
                leftTrack: { chickens: 1, special: 'giant_mascot' },
                rightTrack: { chickens: 0 },
                options: [
                    { 
                        text: "Emergency stop", 
                        choice: 'stop',
                        next: 'stop_trolley',
                        moralPoints: { virtue: 2, deontological: 1 },
                        description: "You activate the emergency brake! The train screeches to a halt."
                    },
                    { 
                        text: "Let it continue", 
                        choice: 'continue',
                        next: 'let_continue',
                        moralPoints: { utilitarian: -1 },
                        description: "The train continues and hits the giant mascot."
                    }
                ]
            },
            do_nothing: {
                id: 'do_nothing',
                description: "The train plowed through the 5 chickens. Ahead, you see another junction with 2 chickens on each track. What now?",
                leftTrack: { chickens: 2 },
                rightTrack: { chickens: 2 },
                options: [
                    { 
                        text: "Divert left this time", 
                        choice: 'left',
                        next: 'balanced_choice',
                        moralPoints: { virtue: 1 },
                        description: "You divert left. Both tracks had equal chickens this time."
                    },
                    { 
                        text: "Continue right", 
                        choice: 'right',
                        next: 'balanced_choice',
                        moralPoints: { virtue: 1 },
                        description: "You continue right. Both tracks had equal chickens this time."
                    }
                ]
            },
            stop_trolley: {
                id: 'stop_trolley',
                description: "The train stopped safely! All chickens are safe. Your journey ends here.",
                leftTrack: { chickens: 0 },
                rightTrack: { chickens: 0 },
                options: []
            },
            let_continue: {
                id: 'let_continue',
                description: "The giant mascot was hit! The train continues. Ahead you see 3 chickens on the left track and 1 on the right.",
                leftTrack: { chickens: 3 },
                rightTrack: { chickens: 1 },
                options: [
                    { 
                        text: "Divert left (3 chickens)", 
                        choice: 'left',
                        next: 'final_choice',
                        moralPoints: { utilitarian: -2 },
                        description: "You chose the path with more chickens."
                    },
                    { 
                        text: "Continue right (1 chicken)", 
                        choice: 'right',
                        next: 'final_choice',
                        moralPoints: { utilitarian: 2 },
                        description: "You minimized harm by choosing the path with fewer chickens."
                    }
                ]
            },
            balanced_choice: {
                id: 'balanced_choice',
                description: "You made a balanced choice. The simulation continues with a new moral dilemma ahead.",
                leftTrack: { chickens: 4 },
                rightTrack: { chickens: 2 },
                options: [
                    { 
                        text: "Divert left (4 chickens)", 
                        choice: 'left',
                        next: 'final_choice',
                        moralPoints: { utilitarian: -2 },
                        description: "You chose the path with more chickens."
                    },
                    { 
                        text: "Continue right (2 chickens)", 
                        choice: 'right',
                        next: 'final_choice',
                        moralPoints: { utilitarian: 2 },
                        description: "You chose to minimize harm."
                    }
                ]
            },
            final_choice: {
                id: 'final_choice',
                description: "The simulation concludes. Your moral profile has been calculated!",
                leftTrack: { chickens: 0 },
                rightTrack: { chickens: 0 },
                options: []
            }
        };

        // Generate chickens on tracks with first-person perspective
        function generateChickens(trackElement, count, position) {
            if (!trackElement) return;
            
            // Clear existing chickens from this track
            const existing = trackElement.querySelectorAll('.rubber-chicken');
            existing.forEach(chicken => chicken.remove());
            
            // Generate new chickens
            for (let i = 0; i < count; i++) {
                const chicken = document.createElement('div');
                chicken.className = 'rubber-chicken';
                chicken.dataset.position = position;
                chicken.dataset.index = i;
                
                // Create chicken parts
                const beak = document.createElement('div');
                beak.className = 'chicken-beak';
                
                const comb = document.createElement('div');
                comb.className = 'chicken-comb';
                
                const eyeLeft = document.createElement('div');
                eyeLeft.className = 'chicken-eye left';
                
                const eyeRight = document.createElement('div');
                eyeRight.className = 'chicken-eye right';
                
                chicken.appendChild(beak);
                chicken.appendChild(comb);
                chicken.appendChild(eyeLeft);
                chicken.appendChild(eyeRight);
                
                // Position chickens along the track with spacing
                // Start them further back (negative Z) so they approach from distance
                const baseZ = -200 - (i * 80);
                const initialScale = 0.4 + (i * 0.08);
                const finalZ = -80 - (i * 40);
                const finalScale = 0.7 + (i * 0.05);
                
                chicken.style.left = '50%';
                chicken.style.transform = `translateX(-50%) translateY(0) translateZ(${baseZ}px) scale(${initialScale})`;
                chicken.style.opacity = 0.6;
                
                trackElement.appendChild(chicken);
                
                // Animate chicken approaching when scenario loads
                setTimeout(() => {
                    chicken.style.transition = 'transform 3s ease-out, opacity 3s ease-out';
                    chicken.style.transform = `translateX(-50%) translateY(0) translateZ(${finalZ}px) scale(${finalScale})`;
                    chicken.style.opacity = 1;
                }, 200 + (i * 100));
            }
        }

        // Load a scenario
        function loadScenario(scenarioId) {
            const scenario = scenarios[scenarioId];
            if (!scenario) return;
            
            gameState.currentScenario = scenario;
            gameState.scenarioHistory.push(scenarioId);
            
            // Update question text
            document.getElementById('questionText').textContent = scenario.description;
            
            // Get track elements
            const leftTrack = document.getElementById('leftTrack');
            const rightTrack = document.getElementById('rightTrack');
            
            // Generate chickens on tracks
            generateChickens(leftTrack, scenario.leftTrack.chickens || 0, 'left');
            generateChickens(rightTrack, scenario.rightTrack.chickens || 0, 'right');
            
            // Update button labels based on scenario options
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            const nextBtn = document.getElementById('nextRoundBtn');
            
            // Reset button states
            leftBtn.disabled = false;
            rightBtn.disabled = false;
            leftBtn.style.display = 'none';
            rightBtn.style.display = 'none';
            nextBtn.style.display = 'none';
            
            // Show appropriate buttons based on scenario
            if (scenario.options && scenario.options.length > 0) {
                scenario.options.forEach((option, index) => {
                    if (option.choice === 'left' || option.choice === 'stop') {
                        leftBtn.textContent = option.text;
                        leftBtn.dataset.optionIndex = index;
                        leftBtn.style.display = 'block';
                    }
                    if (option.choice === 'right' || option.choice === 'continue') {
                        rightBtn.textContent = option.text;
                        rightBtn.dataset.optionIndex = index;
                        rightBtn.style.display = 'block';
                    }
                });
            } else {
                // No options means end scenario - show moral profile
                setTimeout(() => showMoralProfile(), 500);
            }
            
            // Reset track highlighting
            leftTrack.classList.remove('active');
            rightTrack.classList.remove('active');
            
            // Update score display
            updateDisplay();
        }

        // Make a choice
        function makeChoice(direction) {
            if (!gameState.currentScenario) return;
            
            const scenario = gameState.currentScenario;
            const options = scenario.options || [];
            
            // Find the option that matches the choice
            let chosenOption = null;
            if (direction === 'left') {
                chosenOption = options.find(opt => opt.choice === 'left' || opt.choice === 'stop');
            } else if (direction === 'right') {
                chosenOption = options.find(opt => opt.choice === 'right' || opt.choice === 'continue');
            }
            
            if (!chosenOption) return;
            
            // Disable buttons
            document.getElementById('leftBtn').disabled = true;
            document.getElementById('rightBtn').disabled = true;
            
            // Highlight chosen track
            const chosenTrack = direction === 'left' ? document.getElementById('leftTrack') : document.getElementById('rightTrack');
            chosenTrack.classList.add('active');
            
            // Update moral weights
            if (chosenOption.moralPoints) {
                Object.keys(chosenOption.moralPoints).forEach(key => {
                    gameState.adaptiveWeights[key] += chosenOption.moralPoints[key];
                });
            }
            
            // Record choice
            gameState.choices.push({
                scenario: scenario.id,
                choice: chosenOption.choice,
                option: chosenOption
            });
            
            // Animate train moving forward and hitting chickens
            animateTrainMovement(direction, chosenOption);
        }

        // Animate train movement and check collisions
        function animateTrainMovement(direction, option) {
            const chosenTrack = document.getElementById(direction === 'left' ? 'leftTrack' : 'rightTrack');
            const chickens = chosenTrack.querySelectorAll('.rubber-chicken');
            
            let hitCount = 0;
            const animationDuration = 2500;
            const startTime = Date.now();
            
            // Animate chickens approaching and being hit
            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / animationDuration, 1);
                
                chickens.forEach((chicken, index) => {
                    if (chicken.classList.contains('hit')) return;
                    
                    // Get current Z position
                    const currentTransform = chicken.style.transform;
                    const zMatch = currentTransform.match(/translateZ\(([-\d.]+)px\)/);
                    const currentZ = zMatch ? parseFloat(zMatch[1]) : -50;
                    
                    // Move chicken closer (positive Z moves toward viewer)
                    const newZ = currentZ + (progress * 200);
                    const scale = 0.8 + index * 0.05 + (progress * 0.3);
                    
                    // Check if chicken is "hit" (train passed through - Z is close to 0)
                    if (newZ > -30 && !chicken.classList.contains('hit')) {
                        chicken.classList.add('hit');
                        hitCount++;
                        gameState.moralScore += 1;
                        
                        // Add hit animation
                        chicken.style.transition = 'all 0.5s ease-out';
                        chicken.style.transform = `translateX(-50%) translateY(0) translateZ(${newZ}px) scale(0) rotate(720deg)`;
                        chicken.style.opacity = 0;
                    } else if (!chicken.classList.contains('hit')) {
                        chicken.style.transform = `translateX(-50%) translateY(0) translateZ(${newZ}px) scale(${scale})`;
                        chicken.style.opacity = 1 - (progress * 0.2);
                    }
                });
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Animation complete
                    setTimeout(() => {
                        showResult(option);
                    }, 500);
                }
            };
            
            animate();
        }

        // Show result and next scenario
        function showResult(option) {
            // Update question with result
            document.getElementById('questionText').textContent = option.description;
            
            // Show continue button
            const nextBtn = document.getElementById('nextRoundBtn');
            nextBtn.style.display = 'block';
            nextBtn.disabled = false;
            
            // If this is the final scenario, show moral profile
            if (!gameState.currentScenario.options || gameState.currentScenario.options.length === 0) {
                showMoralProfile();
            }
        }

        // Move to next scenario
        function nextScenario() {
            if (!gameState.currentScenario) return;
            
            // Get the last choice made to find the next scenario
            const lastChoice = gameState.choices[gameState.choices.length - 1];
            if (lastChoice && lastChoice.option && lastChoice.option.next) {
                const nextScenarioId = lastChoice.option.next;
                if (scenarios[nextScenarioId]) {
                    loadScenario(nextScenarioId);
                    return;
                }
            }
            
            // Fallback: check if current scenario has end state
            if (!gameState.currentScenario.options || gameState.currentScenario.options.length === 0) {
                showMoralProfile();
            }
        }

        // Show moral profile at the end
        function showMoralProfile() {
            const weights = gameState.adaptiveWeights;
            const maxWeight = Math.max(...Object.values(weights), 1);
            
            // Determine personality
            let personality = "Balanced Chicken Philosopher üßòüêî";
            if (weights.utilitarian > maxWeight * 0.5) {
                personality = "Utilitarian Chicken Minimizer üìäüêî";
            } else if (weights.deontological > maxWeight * 0.5) {
                personality = "Principled Chicken Defender üõ°Ô∏èüêî";
            } else if (weights.virtue > maxWeight * 0.5) {
                personality = "Virtuous Chicken Guardian ‚≠êüêî";
            }
            
            const resultText = `
                <div style="margin-top: 2rem; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px;">
                    <h3 style="margin-bottom: 1rem;">Your Moral Profile</h3>
                    <p style="font-size: 1.5rem; margin-bottom: 1rem;">${personality}</p>
                    <p>Utilitarian: ${weights.utilitarian} | Deontological: ${weights.deontological}</p>
                    <p>Virtue Ethics: ${weights.virtue} | Consequentialist: ${weights.consequentialist}</p>
                    <p style="margin-top: 1rem;">Total Moral Score: ${gameState.moralScore}</p>
                </div>
            `;
            
            document.getElementById('questionText').innerHTML = resultText;
            document.getElementById('nextRoundBtn').style.display = 'none';
        }

        // Update display
        function updateDisplay() {
            const round = gameState.scenarioHistory.length;
            const score = gameState.moralScore;
            document.getElementById('currentRound').textContent = round;
            document.getElementById('currentScore').textContent = score;
            document.getElementById('chickensHit').textContent = score;
        }

        // Initialize the game
        window.addEventListener('load', function() {
            loadScenario('start');
        });
    </script>
</body>
</html>
